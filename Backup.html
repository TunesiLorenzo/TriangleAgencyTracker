<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triangle Agency</title>
<style>
@import url("./css/bestworst_css.css");
/* ________________________________________________________ FONT*/
@font-face {
  font-family: 'ITCAvantGarde';
  src: url('./various/ITCAvantGardeGothic-T.otf') format('opentype');
  font-weight: bold;
  font-style: normal;
}

* {
  font-family: 'ITCAvantGarde', sans-serif !important;
}
/* ________________________________________________________ BODY*/
body {
    margin: 0;
    padding: 0;
	color: #fff;
    font-family: ITCAvantGard;
    overflow-y: scroll;
    width: 100%; 
	background-color: #000
}

#backgroundHue {
  position: fixed;
  inset: 0; /* top:0; left:0; right:0; bottom:0; */
  z-index: -1; /* behind everything */
  background: url('./images/bck.png') repeat center center fixed;
  background-size: cover;
  transition: filter 0.3s linear;
}

/* ________________________________________________________ DEAD*/
/* Death overlay */
.death-overlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 32px;
  font-weight: bold;
  color: red;
  opacity: 0;
  pointer-events: none;
  font-family: 'ITC Avant Gard', sans-serif;
  transform: rotate(0deg);  /* diagonal */
  text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
}

/* Add black underlay behind the text */
.death-overlay::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: -1; /* behind text */
  border-radius: inherit; /* match char box corners */
}

/* Toggle dead state */
.char.dead {
  background-color: rgba(0,0,0,0.2) !important; /* almost transparent */
  color: rgba(255,255,255,0.4);
}

.char.dead .death-overlay {
  opacity: 1;
}
/* ________________________________________________________ Effects*/
#crtScanline {
  position: fixed;
  left: 0;
  width: 100%;
  height: 50px;                 /* thickness of the scanline */
  background: rgba(255,255,255,0.0); /* bright line with slight transparency */
  box-shadow: 0 0 8px rgba(255,255,255,0.0); /* glow to mimic phosphor */
  pointer-events: none;         /* allows clicks through it */
  z-index: 9999;
  bottom: 0;                    /* start at bottom */
}

#scanlineOverlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  width: calc(100vw + 0px);
  height: calc(100vh + 0px);
  
  z-index: 9998;
  background-image: repeating-linear-gradient(
    to bottom,

    /* bright line */
    rgba(255,50,50,0.25) 0px,
    rgba(255,50,50,0.25) 4px,

    /* dark gap */
    rgba(0,0,0,1) 4px,
    rgba(0,0,0,1) 10px
  );
  opacity: 0;
  mix-blend-mode: overlay;
  transition: opacity 0.2s linear;
  background-size: auto;
}

/* page wrapper for jitter - wrap your main content in this or apply to body children */
#pageWrapper {
  will-change: transform;
  transform-origin: center center;
}
/* ________________________________________________________ SPACINGS*/
h1 {
  margin-bottom: 80px; /* adds space below the title */
  z-index:9998;
}

/* ________________________________________________________ STYLE */
.container { display:flex; flex-direction:column; align-items:center; padding:10px; position:relative; }
.char, .world, .counter, .graph-box, .box, .panel {
    background: linear-gradient(145deg, #2b2b2b, #1f1f1f); /* subtle sheen */
    border-radius: 12px;
    padding: 12px;
    position: relative;

    /* Strong dark shadow underneath */
    box-shadow:
        0 15px 25px rgba(0,0,0,0.8),
        0 8px 12px rgba(0,0,0,0.6),
        inset 0 0 4px rgba(255,255,255,0.05); /* inner highlight for ‚Äúpop‚Äù */

    transition: all 0.25s ease;
}

/* Slight lift on hover */
.char:hover, .world:hover, .counter:hover, .graph-box:hover {
    box-shadow:
        0 20px 35px rgba(0,0,0,0.9),
        0 10px 16px rgba(0,0,0,0.7),
        inset 0 0 6px rgba(255,255,255,0.08);
    transform: translateY(-2px);
}

.panel, .box, .graph-box, .char, .world, .counter {
  /* fully opaque base (no transparency) */
  background: linear-gradient(145deg, #2f2f2f 0%, #232323 40%, #1f1f1f 100%);
  border-radius: 12px;
  padding: 12px;
  position: relative;
  color: #fff;

  /* strong outer black shadow for depth */
  box-shadow:
    0 30px 50px rgba(0,0,0,0.95),   /* heavy depth */
    0 12px 20px rgba(0,0,0,0.75);

  /* subtle raised bevel via inset highlights + inner shadow */
  -webkit-box-shadow: 
    0 30px 50px rgba(0,0,0,0.95),
    0 12px 20px rgba(0,0,0,0.75),
    inset 0 1px 0 rgba(255,255,255,0.03),
    inset 0 -6px 18px rgba(0,0,0,0.6);
  box-shadow:
    0 30px 50px rgba(0,0,0,0.95),
    0 12px 20px rgba(0,0,0,0.75),
    inset 0 1px 0 rgba(255,255,255,0.03),
    inset 0 -6px 18px rgba(0,0,0,0.6);

  transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms;
}

/* Slight elevation on hover */
.panel:hover, .box:hover, .graph-box:hover, .char:hover, .world:hover {
  transform: translateY(-4px);
  box-shadow:
    0 40px 70px rgba(0,0,0,0.98),
    0 18px 30px rgba(0,0,0,0.8),
    inset 0 1px 0 rgba(255,255,255,0.04);
}

/* Canvas styling inside graph box - opaque background + inner sheen */
.graph-box {
  overflow: visible;
}
.graph-box canvas {
  display:block;
  border-radius:8px;
  background: linear-gradient(180deg, #272727, #1f1f1f); /* opaque */
  box-shadow:
    inset 0 1px 12px rgba(255,255,255,0.03),  /* inner sheen */
    inset 0 -8px 24px rgba(0,0,0,0.6);
}

/* Two layered glossy highlights (non-transparent) */
.graph-box::before{
  content:"";
  position:absolute;
  left:8px; top:8px;
  width:70%; height:26%;
  pointer-events:none;
  border-radius:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
  mix-blend-mode: normal;
  filter: blur(6px);
  transform: rotate(-6deg);
  opacity:1;
}
.graph-box::after{
  content:"";
  position:absolute;
  left:0; right:0; top:32%;
  height:44%;
  pointer-events:none;
  border-radius:10px;
  background: radial-gradient(ellipse at 50% 30%, rgba(255,255,255,0.06), rgba(255,255,255,0.00) 55%);
  mix-blend-mode: normal;
  filter: blur(8px);
  opacity:1;
}

/* Triangles & inputs match the opaque look */
.triangle, .triangle-down, .counter-input {
  background: linear-gradient(145deg, #343434, #2a2a2a);
  box-shadow: 
    0 10px 18px rgba(0,0,0,0.8),
    inset 0 1px 3px rgba(255,255,255,0.04),
    inset 0 -6px 12px rgba(0,0,0,0.6);
  border-radius:6px;
  color:#fff;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;                      /* full screen */
  z-index: -100;                 /* behind page content */
  background-image: url('background.jpg');
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  will-change: transform;
  transform-origin: center center;
  filter: saturate(0.95) brightness(0.85) contrast(1.02);
  box-shadow: inset 0 120px 160px rgba(0,0,0,0.55); /* dark vignette for contrast */
  animation: bgOscillate var(--bg-osc-duration) var(--bg-osc-ease) infinite;
  pointer-events: none;
}

/* Respect system reduced-motion */
@media (prefers-reduced-motion: reduce) {
  body::before { animation: none; transform: translate3d(0,0,0) scale(1); }
}

/* Top-right buttons */
.top-buttons { position:absolute; top:10px; right:10px; display:flex; gap:10px; opacity:0.6; }
.top-buttons button { padding:5px 10px; border-radius:6px; background:#222; border:none; color:#fff; cursor:pointer; }

/* Colors / Parameters */
:root {
  --anomaly-color: #0a84ff;
  --reality-color: #ffd60a;
  --competency-color: #ff3b30;
  --merit-tint: rgba(255,0,0,0.55); /* Red */
  --demerit-tint: rgba(0,0,255,0.55); /* Blue */
  --gold-border: gold;
}

/* Characters */
.characters { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:200px;}
.char {
  background:#222; padding:10px; border-radius:10px; width:260px;
  display:flex; flex-direction:column; align-items:center; position:relative;
  transition: all 0.3s ease;
}
.char.star { border:2px solid var(--gold-border); }
.char.tilt { transform: rotate(-5deg); }
.char .thumb { position:absolute; top:5px; right:5px; font-size:18px; }

/* Remove button top-left */
.char .remove-btn { position:absolute; top:5px; left:5px; background:#333; border:none; border-radius:50%; width:24px; height:24px; color:#fff; font-weight:bold; }

/* Character content */
.char img { width:80px; height:80px; background:#444; border-radius:33%; margin-bottom:5px; object-fit:cover; }
.stat { width:100%; margin:2px 0; display:flex; justify-content:space-between; }
.stat .label { flex:1; }
.stat .value { flex:1; text-align:right; background:#333; color:#fff; border-radius:4px; padding:1px 4px; }

.tracker-row { display:flex; gap:10px; align-items:center; justify-content:center; margin:4px 0; }
.triangle, .triangle-down {
  width:40px; height:40px; display:flex; justify-content:center; align-items:center;
  font-weight:bold; font-size:14px; cursor:pointer; user-select:none;
}
.triangle { clip-path: polygon(50% 0%,0% 100%,100% 100%); background: red; color:#fff; }
.triangle-down { clip-path: polygon(0% 0%,100% 0%,50% 100%); background: blue; color:#fff; }
.counter-input { width:40px; text-align:center; background:#333; color:#fff; border-radius:4px; border:none; }

/* Tint overlays */
.char.merit { background-color: var(--merit-tint); }
.char.demerit { background-color: var(--demerit-tint); }

/* Triangle Animation */
.triangle.animate, .triangle-down.animate { animation: pop 0.5s ease-out; }
@keyframes pop { 0%{transform:scale(1);}30%{transform:scale(1.5);}100%{transform:scale(1);} }

/* World */
.world-section { display:flex; flex-wrap:wrap; justify-content:center; align-items:flex-start; gap:20px; margin-top:20px; }
.world { display:flex; flex-direction:column; align-items:center; gap:10px; background:#222; padding:10px 20px; border-radius:10px; }
.world-counter { display:flex; gap:5px; align-items:center; }
.counter { background:#555; padding:5px 10px; border-radius:6px; cursor:pointer; user-select:none; }
input[type=text] { padding:2px 5px; border-radius:4px; border:none; background:#333; color:#fff; width:120px; }

/* Graphs */
canvas { background:#222; border-radius:10px; margin:5px; }

.graph-box {
  display:inline-block;
  position:relative;
  border-radius:12px;
  padding:8px;                /* space between canvas and container */
  background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.15));
  box-shadow:
    0 18px 36px rgba(0,0,0,0.85),
    0 8px 14px rgba(0,0,0,0.6),
    inset 0 1px 0 rgba(255,255,255,0.02);
  overflow:visible;           /* allow highlight to spill */
}

/* actual canvas styling */
.graph-box canvas {
  display:block;
  border-radius:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));
  box-shadow: inset 0 1px 12px rgba(255,255,255,0.03);
}

/* thin glossy highlight stripe (top-left) */
.graph-box::before{
  content:"";
  position:absolute;
  left:6px; top:6px;
  width:80%; height:28%;
  pointer-events:none;
  border-radius:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.03));
  mix-blend-mode: screen;
  filter: blur(6px);
  transform: rotate(-6deg);
  opacity:0.9;
}

/* soft center sheen */
.graph-box::after{
  content:"";
  position:absolute;
  left:0; right:0; top:30%;
  height:50%;
  pointer-events:none;
  background: radial-gradient(ellipse at 50% 30%, rgba(255,255,255,0.4), rgba(255,255,255,0.00) 50%);
  border-radius: 10px;
  mix-blend-mode: screen;
  filter: blur(8px);
  opacity:0.9;
}

/* optional hover intensify */
.graph-box:hover::before{ opacity:1; transform: rotate(-4deg) translateY(-2px); }
.graph-box:hover::after{ opacity:1; filter: blur(6px); }


</style>
</head>
<body>
 <div id="backgroundHue"></div>
<div id="pageWrapper">
<div class="container">
<center>
  <h1>Welcome, agents of the <br> TRIANGLE AGENCY</h1>
</center>
  <div class="top-buttons">
    <button onclick="addChar()">Add Character</button>
    <button onclick="resetAll()">Reset</button>
  </div>

  <div class="characters" id="charContainer"></div>

  <div class="world-section">
    <div class="world">
      <div class="sphere-icon">üåê</div>
      <label>LOCAL BRANCH: <input type="text" id="branchName"></label>
      <div class="world-counter">üëÅÔ∏è WITNESSES: <span class="counter" id="witnessCounter">0</span></div>
      <div class="world-counter">üåÄ CHAOS: <span class="counter" id="chaosCounter">0</span></div>
    </div>
    <div class="graph-box">
      <canvas id="lineGraph" width="400" height="120"></canvas>
	  </div>
	  <div class="graph-box">
      <canvas id="histGraph" width="400" height="120"></canvas>
	  	  </div>
	  <div class="graph-box">
      <canvas id="pieGraph" width="200" height="200"></canvas>
    </div>
  </div>
</div>
</div>
<div id="scanlineOverlay"></div>
<div id="crtScanline"></div>



<script type="module">

// ---------------- Parameters ----------------
const MAX_CHARS = 41;
const COLORS = {ANOMALY: '#0a84ff', REALITY: '#ffd60a', COMPETENCY: '#ff3b30' };
const MERIT_TINT = 'merit';
const DEMERIT_TINT = 'demerit';

let charCount = 0;
const charContainer = document.getElementById('charContainer');
const wrapper = document.body; //document.getElementById('pageWrapper');

// ---------------- Character System ----------------
function addChar(data) {
    if (charCount >= MAX_CHARS) return;
    charCount++;

    const c = document.createElement('div'); 
    c.className = 'char';

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.className = 'remove-btn';
    removeBtn.onclick = () => { c.remove(); charCount--; saveSettings(); updateTopCharacters(); };

    const img = document.createElement('img');
    img.src = data?.icon || '';
    img.ondragover = e => e.preventDefault();
    img.ondrop = e => {
        e.preventDefault();
        const f = e.dataTransfer.files[0];
        if (f?.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = () => { img.src = reader.result; saveSettings(); };
            reader.readAsDataURL(f);
        }
    };

    const stats = ['NAME', 'ANOMALY', 'REALITY', 'COMPETENCY'];
    const statDivs = stats.map(s => {
        const div = document.createElement('div'); div.className = 'stat';
        const label = document.createElement('span'); label.className = 'label'; label.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        if (s in COLORS) label.style.color = COLORS[s];
        const value = document.createElement('input'); value.className = 'value'; value.value = data?.[s] || ''; value.style.width = '80px';
        div.append(label, value); return div;
    });

    const merit = createTriangle(true); 
    const demerit = createTriangle(false);
    if (data) { merit.textContent = data.merit || 0; demerit.textContent = data.demerit || 0; }

    const meritCounter = document.createElement('input');
    meritCounter.className = 'counter-input merit';
    meritCounter.type = 'number';
    meritCounter.value = data?.sessionMerit || 0;
    meritCounter.addEventListener('input', saveSettings);

    const demeritCounter = document.createElement('input');
    demeritCounter.className = 'counter-input demerit';
    demeritCounter.type = 'number';
    demeritCounter.value = data?.sessionDemerit || 0;
    demeritCounter.addEventListener('input', saveSettings);

    const trackerRow = document.createElement('div'); trackerRow.className = 'tracker-row';
    trackerRow.append(merit, meritCounter, demerit, demeritCounter);

    c.append(removeBtn, img, ...statDivs, trackerRow);
    charContainer.appendChild(c);
	


const deathBtn = document.createElement('button');
deathBtn.className = 'death-btn';
deathBtn.textContent = '‚úñ'; 
deathBtn.title = "Toggle death state";

const deathOverlay = document.createElement('div');
deathOverlay.className = 'death-overlay';
deathOverlay.textContent = "SICK LEAVE";

c.appendChild(deathOverlay);
deathBtn.onclick = () => {
    c.classList.toggle('dead');
};
c.appendChild(deathBtn);

    saveSettings(); updateTopCharacters();
}
window.addChar=addChar;




// ---------------- Triangle Logic ----------------
function createTriangle(isMerit) {
    const t = document.createElement('div');
    t.className = isMerit ? 'triangle' : 'triangle-down';
    t.textContent = '0';
    t.dataset.type = isMerit ? 'merit' : 'demerit';

    const charBox = () => t.closest('.char');
    const applyEffects = () => { updateTint(charBox()); saveSettings(); updateTopCharacters(); };

    t.addEventListener('click', () => {
        const n = parseInt(t.textContent) || 0; 
        t.textContent = n + 1; 
        animateTriangle(t);
        applyEffects();
        document.dispatchEvent(new CustomEvent('triangle-action', {
      detail: { type: isMerit ? 'merit' : 'demerit', element: t }
    }));
    });

    t.addEventListener('contextmenu', e => {
        e.preventDefault();
        const n = parseInt(t.textContent) || 0;
        t.textContent = Math.max(0, n - 1);
        applyEffects();
    });

    return t;
}

function animateTriangle(el) { el.classList.remove("animate"); void el.offsetWidth; el.classList.add("animate"); }

// ---------------- Tint Logic ----------------
function updateTint(c) {
    const m = parseInt(c.querySelector('.triangle')?.textContent) || 0;
    const d = parseInt(c.querySelector('.triangle-down')?.textContent) || 0;
    c.classList.remove(MERIT_TINT, DEMERIT_TINT);
    if (m > d) c.classList.add(MERIT_TINT);
    else if (d > m) c.classList.add(DEMERIT_TINT);
}
// ---------------- Top Characters ----------------
function updateTopCharacters() {
  const chars = [...document.querySelectorAll('.char')];
  let maxMerit = -1, maxDemerit = -1, meritCount = 0, demeritCount = 0;

  // 1) compute maxima and counts
  chars.forEach(c => {
    const m = parseInt(c.querySelector('.triangle')?.textContent) || 0;
    const d = parseInt(c.querySelector('.triangle-down')?.textContent) || 0;
    if (m > maxMerit) { maxMerit = m; meritCount = 1; } else if (m === maxMerit) meritCount++;
    if (d > maxDemerit) { maxDemerit = d; demeritCount = 1; } else if (d === maxDemerit) demeritCount++;
  });

  // 2) clear previous decorations and overlays
  chars.forEach(c => {
    c.classList.remove('star', 'tilt', 'crooked', 'top-merit', 'top-demerit');
    // remove thumbs
    c.querySelectorAll('.thumb').forEach(t => t.remove());
    // remove previous shine overlay if any
    const oldShine = c.querySelector('.shine-overlay');
    if (oldShine) oldShine.remove();
    // remove previous broken overlay if any
    const oldBroken = c.querySelector('.broken-overlay');
    if (oldBroken) oldBroken.remove();
  });

  // 3) apply new decorations
  chars.forEach(c => {
    const m = parseInt(c.querySelector('.triangle')?.textContent) || 0;
    const d = parseInt(c.querySelector('.triangle-down')?.textContent) || 0;

    // Top MERIT ‚Äî only if unique
    if (m === maxMerit && meritCount === 1 && maxMerit > 0) {
      c.classList.add('star', 'top-merit');
      // star thumb
      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      thumb.textContent = 'üëç';
      c.appendChild(thumb);

      // add shine overlay (only one)
      if (!c.querySelector('.shine-overlay')) {
        const s = document.createElement('div');
        s.className = 'shine-overlay';
        // optional aria
        s.setAttribute('aria-hidden', 'true');
        c.appendChild(s);
      }
    }

    // Top DEMERIT ‚Äî only if unique
   if (d === maxDemerit && demeritCount === 1 && maxDemerit > 0) {
  c.classList.add('tilt', 'top-demerit', 'crooked');

  // add vignette overlay (flickering/pulsating light)
  if (!c.querySelector('.vignette-overlay')) {
    const v = document.createElement('div');
    v.className = 'vignette-overlay';
    v.setAttribute('aria-hidden', 'true');
    c.appendChild(v);
  }
}

    // keep color tint logic intact
    updateTint(c);
  });
}


// ---------------- World Chaos and Witnesses ----------------
let witness = 0, chaos = 0;
import { backgroundhue } from './js/witnesseffects.js';
const bgController = backgroundhue(document.getElementById('backgroundHue'));


const witnessEl = document.getElementById('witnessCounter'), chaosEl = document.getElementById('chaosCounter');
function getChaosValue() { return Number(chaosEl.textContent || 0); }
witnessEl.addEventListener('click', () => { witness++; witnessEl.textContent = witness; saveSettings(); bgController.setWitnessCount(witness,true);});
witnessEl.addEventListener('contextmenu', e => { e.preventDefault(); witness = Math.max(0, witness-1); witnessEl.textContent = witness; saveSettings(); bgController.setWitnessCount(witness);});
chaosEl.addEventListener('click', () => { chaos++; chaosEl.textContent = chaos; updateEffects(); saveSettings(); });
chaosEl.addEventListener('contextmenu', e => { e.preventDefault(); chaos = Math.max(0, chaos-1); chaosEl.textContent = chaos; updateEffects(); saveSettings(); });
document.getElementById('branchName')?.addEventListener('input', saveSettings);



/*-------------UpdateEvents--------------*/
import { stepJitter, animateCRT, updateScanlineOverlay } from './js/effects.js';
import { noise } from './js/noise.js';
const crtLine=document.getElementById('crtScanline')
const scanlineOverlay = document.getElementById('scanlineOverlay');
noise.start();noise.setDensity(0.95);noise.setColor('rgba(0,0,0,0.8)');noise.setIntensity(0.5);noise.setFrequency(0.05);
function updateEffects() {
    const chaosVal = chaos;
	let bottom = parseFloat(crtLine.style.bottom) || 1;
	
	updateScanlineOverlay(scanlineOverlay,chaosVal);
	stepJitter(wrapper, chaosVal);
	animateCRT(crtLine, document.querySelectorAll('.char'), chaosVal, bottom);
	noise.setIntensity(chaosVal/30*0.6);
	noise.setColor('rgba(0,0,0,0.9)');
};

// ---------------- Save / Load ----------------
function saveSettings(){
  const chars=[...document.querySelectorAll('.char')].map(c=>({
    name:c.querySelector('.stat input')?.value||'',
    anomaly:c.querySelectorAll('.stat input')[1]?.value||'',
    reality:c.querySelectorAll('.stat input')[2]?.value||'',
    competency:c.querySelectorAll('.stat input')[3]?.value||'',
    merit:parseInt(c.querySelector('.triangle')?.textContent)||0,
    demerit:parseInt(c.querySelector('.triangle-down')?.textContent)||0,
	sessionMerit: parseInt(c.querySelector('.counter-input.merit')?.value)||0,
    sessionDemerit: parseInt(c.querySelector('.counter-input.demerit')?.value)||0,
    icon:c.querySelector('img')?.src||''
  }));
  localStorage.setItem('rpgSettings', JSON.stringify({chars,world:{branch:branchName.value,witness,chaos}}));
}
function loadSettings(){
  const data=JSON.parse(localStorage.getItem('rpgSettings')||'{}'); charContainer.innerHTML=''; charCount=0;
  if(data.chars) data.chars.forEach(addChar); else for(let i=0;i<2;i++) addChar();
  if(data.world){ branchName.value=data.world.branch||''; witness=data.world.witness||0; chaos=data.world.chaos||0;
    witnessEl.textContent=witness; chaosEl.textContent=chaos; }
}
loadSettings();
updateTopCharacters();
updateEffects();

// ---------------- Reset ----------------
function resetAll(){
  document.querySelectorAll('.char').forEach(c=>{
    c.querySelector('.triangle').textContent='0';
    c.querySelector('.triangle-down').textContent='0';
    c.classList.remove(MERIT_TINT,DEMERIT_TINT,'star','tilt');
    c.querySelectorAll('.thumb').forEach(t=>t.remove());
	
  });
  witness=0; chaos=0;
  witnessEl.textContent=0; chaosEl.textContent=0;
  

  saveSettings(); updateTopCharacters();
    updateScanlineOverlay();
  updateEffects();
}
window.resetAll = resetAll;

/* ---------- Merit / Demerit Effects ---------- */
let smoothMode=false, chaosMode=false;
let effectTimer=null;

function triggerSmoothMode(){ 
    smoothMode=true; chaosMode=false; 
    resetEffectTimer();
}

function triggerChaosMode(){ 
    chaosMode=true; smoothMode=false; 
    resetEffectTimer();
}

function resetEffectTimer(){
    if(effectTimer) clearTimeout(effectTimer);
    effectTimer=setTimeout(()=>{ smoothMode=false; chaosMode=false; }, 10000); // effect lasts 3s
}
 import { createCharts } from './js/chart.js';

  const charts = createCharts({
    lineCanvas: 'lineGraph',   // or pass the DOM element
    histCanvas: 'histGraph',
    pieCanvas: 'pieGraph',
    intervalMs: 80
  });

  charts.start();


document.addEventListener('triangle-action', (e) => {
  if (e.detail.type === 'merit') charts.triggerSmoothMode();
  else charts.triggerChaosMode();
});




saveSettings()
</script>
</body>
</html>
